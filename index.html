<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Registro de Salud</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js para gráficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Kalam:wght@300;400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">

    <style>
        /* Estilos base y configuración de modo oscuro */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark {
            --bg-color: #1f2937;
            --bg-secondary-color: #374151;
            --text-color: #f3f4f6;
            --text-secondary-color: #d1d5db;
            --border-color: #4b5563;
        }
        html.dark body {
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        /* Clases personalizadas */
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: background-color 0.3s;
        }
        .dark .card {
            background-color: var(--bg-secondary-color);
            border: 1px solid var(--border-color);
        }
        .nav-button {
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }
        .nav-button.active {
            background-color: #10b981; /* emerald-500 */
            color: white;
        }
        .dark .nav-button.active {
            background-color: #34d399; /* emerald-400 */
        }
        /* Animaciones */
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        .fade-out { animation: fadeOut 0.5s ease-in-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: translateY(0); }
            to { opacity: 0; transform: translateY(10px); visibility: hidden; }
        }

        .material-icons-outlined { font-size: 1.25rem; }
        
        /* Estilos para el Toggle Switch */
        .toggle-checkbox:checked { right: 0; border-color: #34d399; }
        .toggle-checkbox:checked + .toggle-label { background-color: #34d399; }
        
        .nav-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .nav-container::-webkit-scrollbar { display: none; }
        
        /* Estilos para el calendario de reporte (Termómetro de Alegría) */
        .day-joy { background-color: #6ee7b7; color: #064e3b; } /* emerald-300 */
        .dark .day-joy { background-color: #047857; color: #d1fae5;}
        .day-happy { background-color: #a7f3d0; color: #065f46;} /* emerald-200 */
        .dark .day-happy { background-color: #065f46; color: #d1fae5;}
        .day-neutral { background-color: #fde047; color: #78350f;} /* yellow-300 */
        .dark .day-neutral { background-color: #a16207; color: #fefce8;}
        .day-sad { background-color: #fca5a5; color: #7f1d1d;} /* red-300 */
        .dark .day-sad { background-color: #991b1b; color: #fee2e2;}
        .day-bad { background-color: #ef4444; color: #fee2e2;} /* red-500 */
        .dark .day-bad { background-color: #7f1d1d; color: #fee2e2;}

        /* Estilos para la vista de Bienvenida */
        #splash-view {
            background-image: url('https://images.unsplash.com/photo-1506126613408-eca07ce68773?q=80&w=2599&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        #splash-view .overlay {
            background-color: rgba(255, 255, 255, 0.7);
        }
        .dark #splash-view .overlay {
             background-color: rgba(31, 41, 55, 0.7);
        }

        /* Estilos para el Diario */
        .journal-paper {
            background-color: #fdfaf4;
            font-family: 'Kalam', cursive;
            color: #4b5563;
            background-image: repeating-linear-gradient(to bottom, #e5e7eb 0, #e5e7eb 1px, transparent 1px, transparent 1.75rem);
            line-height: 1.75rem;
        }
        .dark .journal-paper {
            background-color: #4b5563;
            color: #e5e7eb;
            background-image: repeating-linear-gradient(to bottom, #6b7280 0, #6b7280 1px, transparent 1px, transparent 1.75rem);
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <!-- Vista de Bienvenida (Splash Screen) -->
    <div id="splash-view" class="fixed inset-0 z-50">
        <div class="overlay absolute inset-0"></div>
        <div class="relative z-10 flex flex-col items-center justify-center h-full p-8 text-center">
            <div class="fade-in">
                <h1 class="text-4xl md:text-5xl font-bold text-emerald-700 dark:text-emerald-300 mb-4">Mi Registro de Salud</h1>
                <p id="welcome-message" class="text-xl text-gray-700 dark:text-gray-300 mb-8 max-w-2xl mx-auto"></p>
                <button id="enter-app-btn" class="bg-emerald-500 text-white py-3 px-8 rounded-full text-lg font-semibold hover:bg-emerald-600 transition-transform transform hover:scale-105">
                    Continuar
                </button>
            </div>
            <p class="absolute bottom-4 text-xs text-gray-600 dark:text-gray-400">
                Creada por y para controlar el estado de mi salud (Edison Chicango)
            </p>
        </div>
    </div>

    <div id="main-container" class="container mx-auto max-w-4xl p-4 min-h-screen hidden">
        <!-- Encabezado -->
        <header class="flex justify-between items-center mb-6">
            <h1 class="text-2xl md:text-3xl font-bold text-emerald-600 dark:text-emerald-400">Mi Registro de Salud</h1>
            <div class="flex items-center gap-2">
                <button id="home-btn" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <span class="material-icons-outlined">home</span>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <span class="material-icons-outlined" id="theme-icon">light_mode</span>
                </button>
            </div>
        </header>

        <!-- Navegación -->
        <div class="nav-container card mb-6">
            <nav class="p-2 flex justify-start sm:justify-around text-xs sm:text-sm">
                <button data-view="dashboard" class="nav-button active flex-shrink-0 py-2 px-3 rounded-md flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">today</span> Hoy
                </button>
                <button data-view="symptoms" class="nav-button flex-shrink-0 py-2 px-3 rounded-md flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">sick</span> Síntomas
                </button>
                 <button data-view="weight" class="nav-button flex-shrink-0 py-2 px-3 rounded-md flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">scale</span> Peso
                </button>
                 <button data-view="notes" class="nav-button flex-shrink-0 py-2 px-3 rounded-md flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">edit_note</span> Notas
                </button>
                <button data-view="journal" class="nav-button flex-shrink-0 py-2 px-3 rounded-md flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">book</span> Diario
                </button>
                <button data-view="exams" class="nav-button flex-shrink-0 py-2 px-3 rounded-md flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">science</span> Exámenes
                </button>
                 <button data-view="compare" class="nav-button flex-shrink-0 py-2 px-3 rounded-md flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">compare_arrows</span> Comparar
                </button>
                <button data-view="report" class="nav-button flex-shrink-0 py-2 px-3 rounded-md flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">assessment</span> Reporte
                </button>
                <button data-view="manage" class="nav-button flex-shrink-0 py-2 px-3 rounded-md flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">settings</span> Gestión
                </button>
            </nav>
        </div>

        <main>
            <!-- Vista del Día (Dashboard) -->
            <div id="dashboard-view" class="view fade-in">
                <div class="card p-6 mb-6">
                    <div class="flex justify-between items-center">
                         <h2 class="text-xl font-semibold mb-1" id="dashboard-date-display"></h2>
                         <input type="date" id="dashboard-day-picker" class="p-2 border rounded-md bg-transparent dark:border-gray-600">
                    </div>
                    <p class="text-gray-500 dark:text-gray-400 mb-4" id="current-phase"></p>
                    <div id="today-supplements" class="space-y-4"></div>
                    <p id="no-supplements-today" class="text-center text-gray-500 dark:text-gray-400 py-4 hidden">No hay suplementos programados para hoy.</p>
                    <button id="save-dashboard-btn" class="w-full mt-4 bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600">Guardar Cambios del Día</button>
                </div>
                <div class="card p-6">
                     <h3 class="text-lg font-semibold mb-4">Resumen Semanal</h3>
                     <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                         <div id="weekly-progress-bar" class="bg-emerald-500 h-4 rounded-full transition-all duration-500" style="width: 0%;"></div>
                     </div>
                     <p id="weekly-progress-text" class="text-right mt-2 text-sm font-medium text-gray-600 dark:text-gray-300">0% completado</p>
                </div>
            </div>

            <!-- Vista de Síntomas -->
            <div id="symptoms-view" class="view hidden fade-in card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Registro de Síntomas</h2>
                     <input type="date" id="symptoms-day-picker" class="p-2 border rounded-md bg-transparent dark:border-gray-600">
                </div>
                <div id="symptoms-checklist" class="space-y-4"></div>
                <button id="save-symptoms-btn" class="w-full mt-4 bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600">Guardar Síntomas del Día</button>
                <button id="symptoms-uncheck-all" class="w-full mt-2 text-sm bg-gray-200 dark:bg-gray-700 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">Desmarcar Todo</button>
            </div>
            
            <!-- Vista de Peso -->
            <div id="weight-view" class="view hidden fade-in space-y-6">
                 <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Registrar Peso</h2>
                    <form id="weight-form" class="flex items-end gap-4">
                        <div>
                            <label for="weight-date" class="block text-sm font-medium mb-1">Fecha</label>
                            <input type="date" id="weight-date" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                        </div>
                        <div>
                             <label for="weight-kg" class="block text-sm font-medium mb-1">Peso (kg)</label>
                            <input type="number" step="0.1" id="weight-kg" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                        </div>
                        <button type="submit" class="bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600">Guardar</button>
                    </form>
                </div>
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Historial de Peso</h2>
                    <ul id="weight-history" class="space-y-2"></ul>
                    <div class="mt-6">
                        <canvas id="weight-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Vista de Notas -->
            <div id="notes-view" class="view hidden fade-in space-y-6">
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Crear o Editar Nota</h2>
                    <form id="note-form" class="space-y-4">
                        <div>
                            <label for="note-date" class="block text-sm font-medium mb-1">Fecha</label>
                            <input type="date" id="note-date" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">¿Cómo te sentiste? (puedes marcar varios)</label>
                            <div id="note-mood-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2 mt-4">Razones (puedes marcar varias)</label>
                            <div id="note-reason-checkboxes" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                        </div>

                        <div>
                            <label for="note-text" class="block text-sm font-medium mb-1">Nota Rápida</label>
                            <textarea id="note-text" rows="5" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600">Guardar Nota</button>
                    </form>
                </div>

                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Resumen Gráfico de Sentimientos</h3>
                     <div class="max-w-md mx-auto">
                        <canvas id="notes-chart"></canvas>
                    </div>
                </div>

                 <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Historial de Notas</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
                        <input type="date" id="notes-filter-date" class="p-2 border rounded-md bg-transparent dark:border-gray-600">
                        <select id="notes-filter-mood" class="p-2 border rounded-md bg-transparent dark:border-gray-600"></select>
                        <select id="notes-filter-reason" class="p-2 border rounded-md bg-transparent dark:border-gray-600"></select>
                    </div>
                    <button id="notes-clear-filters" class="w-full text-sm bg-gray-200 dark:bg-gray-700 py-2 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">Limpiar Filtros</button>
                    <div id="notes-list" class="space-y-4 mt-4"></div>
                </div>
            </div>

            <!-- Vista de Diario (Notas 2) -->
            <div id="journal-view" class="view hidden fade-in card p-6">
                <h2 class="text-2xl font-semibold mb-4 font-serif">Diario Personal</h2>
                <form id="journal-form" class="space-y-4">
                     <div>
                        <label for="journal-date" class="block text-sm font-medium mb-1">Fecha</label>
                        <input type="date" id="journal-date" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                    </div>
                    <div>
                        <textarea id="journal-text" rows="10" class="w-full p-4 border rounded-md journal-paper dark:border-gray-600" placeholder="Escribe aquí tus pensamientos..."></textarea>
                    </div>
                    <button type="submit" class="w-full bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600">Guardar Entrada</button>
                </form>
                 <button id="show-journal-report-btn" class="w-full mt-4 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">menu_book</span> Ver Diario Consolidado
                </button>
            </div>


            <!-- Vista de Exámenes -->
            <div id="exams-view" class="view hidden fade-in card p-6">
                <h2 class="text-xl font-semibold mb-4">Registrar Exámenes</h2>
                <div class="flex items-end gap-4 mb-4">
                     <div>
                        <label for="exam-table-date" class="block text-sm font-medium mb-1">Fecha de los Resultados</label>
                        <input type="date" id="exam-table-date" class="p-2 border rounded-md bg-transparent dark:border-gray-600">
                    </div>
                    <button id="save-exams-btn" class="bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600">Guardar Cambios</button>
                </div>
                 <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead>
                            <tr class="border-b dark:border-gray-700">
                                <th class="p-2">Examen</th>
                                <th class="p-2 hidden sm:table-cell">Frecuencia</th>
                                <th class="p-2">Rango Normal</th>
                                <th class="p-2">Valor</th>
                            </tr>
                        </thead>
                        <tbody id="exams-table-body"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Vista de Comparativas -->
             <div id="compare-view" class="view hidden fade-in card p-6">
                <h2 class="text-xl font-semibold mb-4">Comparativa de Exámenes</h2>
                 <button id="export-exams-json" class="mb-4 bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 flex items-center justify-center gap-2">
                    <span class="material-icons-outlined">download</span> Exportar a JSON
                </button>
                <div id="compare-table-container" class="overflow-x-auto"></div>
            </div>

            <!-- Vista de Reporte -->
            <div id="report-view" class="view hidden fade-in card p-6">
                 <h2 class="text-xl font-semibold mb-4">Reporte Mensual</h2>
                <div class="flex justify-between items-center mb-4">
                    <button id="report-prev-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><span class="material-icons-outlined">chevron_left</span></button>
                    <h3 id="report-month-year" class="text-xl font-semibold"></h3>
                    <button id="report-next-month" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><span class="material-icons-outlined">chevron_right</span></button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-xs font-bold mb-2">
                    <span>D</span><span>L</span><span>M</span><span>X</span><span>J</span><span>V</span><span>S</span>
                </div>
                <div id="report-calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
                
            </div>

            <!-- Vista de Gestión -->
            <div id="manage-view" class="view hidden fade-in space-y-6">
                <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Seguridad de Notas</h3>
                    <button id="change-password-btn" class="w-full bg-yellow-500 text-white py-2 px-4 rounded-md hover:bg-yellow-600">Cambiar Contraseña</button>
                </div>
                 <div class="card p-6">
                    <h3 class="text-lg font-semibold mb-4">Gestionar Opciones de Notas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h4 class="font-medium mb-2">Sentimientos</h4>
                            <div id="moods-list-manage" class="space-y-2 mb-2"></div>
                            <form id="add-mood-form" class="flex gap-2">
                                <input type="text" id="new-mood-input" placeholder="Nuevo sentimiento" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                                <select id="new-mood-group" class="p-2 border rounded-md bg-transparent dark:border-gray-600">
                                    <option value="Positivos">Positivo</option>
                                    <option value="Negativos">Negativo</option>
                                </select>
                                <button type="submit" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600"><span class="material-icons-outlined">add</span></button>
                            </form>
                        </div>
                        <div>
                            <h4 class="font-medium mb-2">Razones</h4>
                            <div id="reasons-list-manage" class="space-y-2 mb-2"></div>
                             <form id="add-reason-form" class="flex gap-2">
                                <input type="text" id="new-reason-input" placeholder="Nueva razón" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                                <button type="submit" class="bg-blue-500 text-white p-2 rounded-md hover:bg-blue-600"><span class="material-icons-outlined">add</span></button>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Gestionar Fases y Suplementos</h2>
                    <div id="phases-container" class="space-y-4"></div>
                    <button id="add-phase-btn" class="mt-4 w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">Agregar Nueva Fase</button>
                </div>
                 <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Carga Masiva de Suplementos</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Sube un archivo JSON para agregar o actualizar fases y suplementos.</p>
                    <input type="file" id="json-upload" accept=".json" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100"/>
                 </div>
                 <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4">Recordatorios</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                        Activa para recibir un recordatorio diario. Necesitarás conceder permisos de notificación en tu navegador.
                    </p>
                    <div class="flex items-center justify-between">
                        <label for="notifications-toggle" class="font-medium">Activar recordatorio</label>
                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="notifications-toggle" id="notifications-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="notifications-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 dark:bg-gray-600 cursor-pointer"></label>
                        </div>
                    </div>
                    <div id="notification-time-container" class="mt-4 hidden">
                        <label for="notification-time" class="block text-sm font-medium mb-1">Hora del recordatorio:</label>
                        <input type="time" id="notification-time" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600">
                    </div>
                </div>
                 <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-red-600 dark:text-red-400">Zona de Peligro</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
                        Esto eliminará permanentemente todo tu historial y cualquier cambio que hayas hecho. La aplicación volverá a su estado inicial.
                    </p>
                    <button id="reset-app-btn" class="w-full bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 flex items-center justify-center gap-2">
                        <span class="material-icons-outlined">delete_forever</span>
                        Resetear Aplicación
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Modales -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="card p-6 w-full max-w-sm text-center">
            <span class="material-icons-outlined text-5xl text-emerald-500 mx-auto mb-4">lock</span>
            <h2 id="password-modal-title" class="text-lg font-bold mb-4">Acceso a Notas</h2>
            <p id="password-modal-text" class="text-sm text-gray-500 dark:text-gray-400 mb-4"></p>
            <form id="password-form">
                 <input type="password" id="password-old-input" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600 mb-4 hidden" placeholder="Contraseña actual">
                <input type="password" id="password-input" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600 mb-4" required placeholder="Contraseña">
                <input type="password" id="password-confirm-input" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600 mb-4 hidden" placeholder="Confirma tu contraseña">
                <div class="flex justify-center gap-4">
                    <button type="button" id="cancel-password-btn" class="py-2 px-6 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                    <button type="submit" class="bg-emerald-500 text-white py-2 px-6 rounded-md hover:bg-emerald-600">Aceptar</button>
                </div>
            </form>
        </div>
    </div>
    
     <div id="toast-notification" class="fixed bottom-5 right-5 card p-4 max-w-sm text-center hidden fade-in z-50">
        <p id="toast-message"></p>
    </div>

    <div id="supplement-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="card p-6 w-full max-w-md">
            <h2 id="modal-title" class="text-lg font-bold mb-4"></h2>
            <form id="supplement-form">
                <input type="hidden" id="modal-phase-id">
                <input type="hidden" id="modal-supplement-index">
                <div class="mb-4">
                    <label for="supplement-name" class="block text-sm font-medium mb-1">Nombre</label>
                    <input type="text" id="supplement-name" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="supplement-dosis" class="block text-sm font-medium mb-1">Dosis</label>
                    <input type="text" id="supplement-dosis" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="supplement-horario" class="block text-sm font-medium mb-1">Horario</label>
                    <input type="text" id="supplement-horario" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-modal" class="py-2 px-4 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                    <button type="submit" class="bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="phase-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="card p-6 w-full max-w-md">
            <h2 id="phase-modal-title" class="text-lg font-bold mb-4"></h2>
            <form id="phase-form">
                <input type="hidden" id="modal-phase-edit-id">
                <div class="mb-4">
                    <label for="phase-name" class="block text-sm font-medium mb-1">Nombre de la Fase</label>
                    <input type="text" id="phase-name" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="phase-start" class="block text-sm font-medium mb-1">Fecha de Inicio</label>
                    <input type="date" id="phase-start" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                </div>
                <div class="mb-4">
                    <label for="phase-end" class="block text-sm font-medium mb-1">Fecha de Fin</label>
                    <input type="date" id="phase-end" class="w-full p-2 border rounded-md bg-transparent dark:border-gray-600" required>
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-phase-modal" class="py-2 px-4 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                    <button type="submit" class="bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="reset-confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="card p-6 w-full max-w-md text-center">
            <span class="material-icons-outlined text-5xl text-red-500 mx-auto mb-4">warning_amber</span>
            <h2 class="text-lg font-bold mb-2">¿Estás realmente seguro?</h2>
            <p class="text-sm text-gray-500 dark:text-gray-400 mb-6">
                Esta acción es irreversible y eliminará todo tu historial y personalizaciones. La aplicación volverá a su estado inicial.
            </p>
            <div class="flex justify-center gap-4">
                <button id="cancel-reset-btn" class="py-2 px-6 rounded-md hover:bg-gray-200 dark:hover:bg-gray-600">Cancelar</button>
                <button id="confirm-reset-btn" class="bg-red-500 text-white py-2 px-6 rounded-md hover:bg-red-600">Sí, Resetear</button>
            </div>
        </div>
    </div>
    <div id="report-day-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="card p-6 w-full max-w-md">
            <h2 id="report-day-title" class="text-lg font-bold mb-4"></h2>
            <div id="report-day-content" class="space-y-3 text-sm"></div>
            <div class="flex justify-end mt-6">
                <button id="close-report-day-modal" class="bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600">Cerrar</button>
            </div>
        </div>
    </div>
     <div id="journal-report-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-40">
        <div class="card p-6 w-full max-w-2xl h-5/6 flex flex-col">
            <h2 class="text-xl font-bold mb-4">Diario Consolidado</h2>
            <div id="journal-report-content" class="flex-grow overflow-y-auto pr-2 space-y-4 journal-paper p-4"></div>
            <div class="flex justify-end mt-6">
                <button id="close-journal-report-modal" class="bg-emerald-500 text-white py-2 px-4 rounded-md hover:bg-emerald-600">Cerrar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        // --- ESTADO DE LA APLICACIÓN ---
        const AppState = {
            data: { fases: [] },
            symptomList: [],
            examList: {},
            welcomeMessages: [],
            weightMessages: {},
            history: {}, // Suplementos
            symptoms: {},
            weight: {},
            notes: {},
            journal: {},
            exams: {},
            settings: {
                theme: 'light',
                notifications: { enabled: false, time: '08:00' },
                notesPassword: null,
                moodOptions: { 'Positivos': ['Amado', 'Feliz', 'Agradecido'], 'Negativos': ['Triste', 'Enojado', 'Decepcionado'] },
                reasonOptions: ['jr', 'Salud', 'Mamita', 'Vida', 'lc', 'st', 'Trabajo', 'Discusión j', 'Discusión s', 'Economía', 'Yo']
            },
            currentDate: new Date(),
            reportDate: new Date(),
            activeView: 'dashboard',
            notesUnlocked: false,
            passwordMode: 'login', // 'login', 'create', 'change', 'reset'
            viewToUnlock: null,
        };
        
        // --- ELEMENTOS DEL DOM ---
        const $ = (selector) => document.querySelector(selector);
        
        // --- INICIALIZACIÓN ---
        async function init() {
            await loadState();
            setupEventListeners();
            
            if (sessionStorage.getItem('welcomeShown')) {
                $('#splash-view').classList.add('hidden');
                $('#main-container').classList.remove('hidden');
            } else {
                const message = AppState.welcomeMessages[Math.floor(Math.random() * AppState.welcomeMessages.length)] || "Cuida tu cuerpo, es el único lugar que tienes para vivir.";
                $('#welcome-message').textContent = message;
                $('#splash-view').classList.remove('hidden');
                $('#main-container').classList.add('hidden');
            }

            render();
            scheduleNextNotification();
        }

        // --- LÓGICA DE DATOS Y ESTADO ---
        function saveState() {
            localStorage.setItem('healthApp', JSON.stringify({
                data: AppState.data,
                history: AppState.history,
                symptoms: AppState.symptoms,
                weight: AppState.weight,
                notes: AppState.notes,
                journal: AppState.journal,
                exams: AppState.exams,
                settings: AppState.settings
            }));
        }

        async function loadState() {
            try {
                const [symptomsRes, examsRes, welcomeRes, weightRes, supplementsRes] = await Promise.all([
                    fetch('sintomas.json').catch(e=>null), 
                    fetch('examenes.json').catch(e=>null),
                    fetch('bienvenida.json').catch(e=>null), 
                    fetch('mensajes.json').catch(e=>null),
                    fetch('suplementos.json').catch(e=>null)
                ]);
                if (symptomsRes && symptomsRes.ok) AppState.symptomList = await symptomsRes.json();
                if (examsRes && examsRes.ok) AppState.examList = (await examsRes.json()).examenes;
                if (welcomeRes && welcomeRes.ok) AppState.welcomeMessages = await welcomeRes.json();
                if (weightRes && weightRes.ok) AppState.weightMessages = await weightRes.json();

                const savedState = localStorage.getItem('healthApp');
                if (savedState) {
                    const parsed = JSON.parse(savedState);
                     // Merge settings to avoid overwriting new defaults
                    const defaultSettings = {
                        theme: 'light',
                        notifications: { enabled: false, time: '08:00' },
                        notesPassword: null,
                        moodOptions: { 'Positivos': ['Amado', 'Feliz', 'Agradecido'], 'Negativos': ['Triste', 'Enojado', 'Decepcionado'] },
                        reasonOptions: ['jr', 'Salud', 'Mamita', 'Vida', 'lc', 'st', 'Trabajo', 'Discusión j', 'Discusión s', 'Economía', 'Yo']
                    };
                    Object.assign(AppState, {
                        data: parsed.data || { fases: [] },
                        history: parsed.history || {},
                        symptoms: parsed.symptoms || {},
                        weight: parsed.weight || {},
                        notes: parsed.notes || {},
                        journal: parsed.journal || {},
                        exams: parsed.exams || {},
                        settings: { ...defaultSettings, ...parsed.settings }
                    });
                } else {
                    if (supplementsRes && supplementsRes.ok) AppState.data = await supplementsRes.json();
                }

            } catch (error) {
                console.error("Error cargando archivos JSON iniciales:", error);
            }
        }
        
        // --- FUNCIONES DE UTILIDAD ---
        const formatDate = (date, options = { year: 'numeric', month: 'long', day: 'numeric' }) => date.toLocaleDateString('es-ES', options);
        const toISODateString = (date) => new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0];

        // --- LÓGICA DE NAVEGACIÓN Y VISTAS ---
        function navigateTo(view) {
            if (['notes', 'journal'].includes(AppState.activeView) && !['notes', 'journal'].includes(view)) {
                AppState.notesUnlocked = false;
            }
            
            if (['notes', 'journal'].includes(view) && !AppState.notesUnlocked) {
                AppState.viewToUnlock = view;
                promptForPassword('login');
                return;
            }
            AppState.activeView = view;
            if (['dashboard', 'symptoms'].includes(view)) {
                AppState.currentDate = new Date();
            }
            render();
        }

        // --- LÓGICA DE RENDERIZADO ---
        function render() {
            const renderers = {
                dashboard: renderDashboard, symptoms: renderSymptomsView, weight: renderWeightView,
                notes: renderNotesView, journal: renderJournalView, exams: renderExamsView, compare: renderCompareView,
                report: renderReportView, manage: renderManageView
            };
            if(renderers[AppState.activeView]) renderers[AppState.activeView]();
            
            document.querySelectorAll('#main-container .view').forEach(v => v.classList.add('hidden'));
            $(`#${AppState.activeView}-view`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            const activeButton = $(`.nav-button[data-view="${AppState.activeView}"]`);
            if (activeButton) activeButton.classList.add('active');

            applyTheme();
        }

        function renderDashboard() {
            const day = AppState.currentDate;
            $('#dashboard-date-display').textContent = formatDate(day, { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            $('#dashboard-day-picker').value = toISODateString(day);
            const phase = getCurrentPhase(day);
            $('#current-phase').textContent = phase ? `Estás en: ${phase.nombre}` : 'No hay una fase activa para hoy.';
            const supplements = getSupplementsForDate(day);
            const container = $('#today-supplements');
            container.innerHTML = '';
            if (supplements.length > 0) {
                 $('#no-supplements-today').classList.add('hidden');
                 supplements.forEach(sup => {
                    const dateStr = toISODateString(day);
                    const isTaken = AppState.history[dateStr] && AppState.history[dateStr][sup.nombre];
                    container.innerHTML += `<div class="flex items-center justify-between p-3 rounded-lg border dark:border-gray-700 bg-gray-50 dark:bg-gray-800"><div class="flex items-center"><input type="checkbox" id="sup-${dateStr}-${sup.nombre.replace(/\s/g, '')}" data-name="${sup.nombre}" ${isTaken ? 'checked' : ''} class="h-6 w-6 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 mr-4"><div><label for="sup-${dateStr}-${sup.nombre.replace(/\s/g, '')}" class="font-semibold">${sup.nombre}</label><p class="text-sm text-gray-500 dark:text-gray-400">${sup.dosis} - ${sup.horario}</p></div></div><span class="material-icons-outlined text-2xl ${isTaken ? 'text-emerald-500' : 'text-gray-400'}">${isTaken ? 'check_circle' : 'radio_button_unchecked'}</span></div>`;
                });
            } else {
                $('#no-supplements-today').classList.remove('hidden');
            }
            renderWeeklyProgress();
        }
        
        function renderWeeklyProgress() {
            let totalSupps = 0;
            let takenSupps = 0;
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const day = new Date(today);
                day.setDate(today.getDate() - i);
                const dateStr = toISODateString(day);
                const daySupps = getSupplementsForDate(day);
                totalSupps += daySupps.length;
                if (AppState.history[dateStr]) {
                    const takenOnDay = daySupps.filter(sup => AppState.history[dateStr][sup.nombre]).length;
                    takenSupps += takenOnDay;
                }
            }
            const percentage = totalSupps > 0 ? Math.round((takenSupps / totalSupps) * 100) : 0;
            $('#weekly-progress-bar').style.width = `${percentage}%`;
            $('#weekly-progress-text').textContent = `${percentage}% completado esta semana`;
        }

        function renderSymptomsView() {
            const day = AppState.currentDate;
            $('#symptoms-day-picker').value = toISODateString(day);
            const container = $('#symptoms-checklist');
            container.innerHTML = '';
            const dateStr = toISODateString(day);
            const dailySymptoms = AppState.symptoms[dateStr];
            const positiveDefaults = ["Buena energía durante el día", "Dormí bien", "Estado de ánimo estable"];

            (AppState.symptomList || []).forEach(category => {
                let symptomsHtml = (category.sintomas || []).map(symptom => {
                    let isChecked = dailySymptoms ? dailySymptoms[symptom] : positiveDefaults.includes(symptom);
                    return `<div class="flex items-center"><input type="checkbox" id="symptom-${dateStr}-${symptom.replace(/\s/g, '')}" data-symptom="${symptom}" ${isChecked ? 'checked' : ''} class="h-5 w-5 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 mr-3"><label for="symptom-${dateStr}-${symptom.replace(/\s/g, '')}">${symptom}</label></div>`;
                }).join('');
                container.innerHTML += `<h3 class="text-lg font-semibold mb-2 mt-4">${category.categoria}</h3><div class="grid grid-cols-1 sm:grid-cols-2 gap-2">${symptomsHtml}</div>`;
            });
        }
        
        let weightChartInstance = null;
        function renderWeightView() {
            $('#weight-date').value = toISODateString(new Date());
            const container = $('#weight-history');
            container.innerHTML = '';
            const sortedDates = Object.keys(AppState.weight).sort((a,b) => new Date(b) - new Date(a));
            sortedDates.forEach(dateStr => {
                container.innerHTML += `<li class="flex justify-between items-center p-2 border-b dark:border-gray-700"><span>${formatDate(new Date(dateStr + 'T12:00:00Z'))}</span><span class="font-semibold">${AppState.weight[dateStr]} kg</span></li>`;
            });
            
            const chartCtx = $('#weight-chart').getContext('2d');
            const chartData = Object.keys(AppState.weight).sort().map(date => ({x: date, y: AppState.weight[date]}));
            if(weightChartInstance) weightChartInstance.destroy();
            weightChartInstance = new Chart(chartCtx, {
                type: 'line',
                data: { datasets: [{ label: 'Peso (kg)', data: chartData, borderColor: '#10b981', backgroundColor: '#10b98133', fill: true, tension: 0.1 }] },
                options: { scales: { x: { type: 'time', time: { unit: 'day' } } } }
            });
        }

        let notesChartInstance = null;
        function renderNotesView() {
            // Render form
            $('#note-date').value = toISODateString(new Date());
            const { moodOptions, reasonOptions } = AppState.settings;
            const moodContainer = $('#note-mood-checkboxes');
            moodContainer.innerHTML = '';
            Object.values(moodOptions).flat().forEach(mood => {
                moodContainer.innerHTML += `<div class="flex items-center"><input type="checkbox" id="mood-${mood}" name="mood" value="${mood}" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 mr-2"><label for="mood-${mood}">${mood}</label></div>`;
            });
            const reasonContainer = $('#note-reason-checkboxes');
            reasonContainer.innerHTML = '';
            reasonOptions.forEach(reason => {
                reasonContainer.innerHTML += `<div class="flex items-center"><input type="checkbox" id="reason-${reason}" name="reason" value="${reason}" class="h-4 w-4 rounded border-gray-300 text-emerald-600 focus:ring-emerald-500 mr-2"><label for="reason-${reason}">${reason}</label></div>`;
            });

            // Render History List with filters
            populateNotesFilters();
            const filterDate = $('#notes-filter-date').value;
            const filterMood = $('#notes-filter-mood').value;
            const filterReason = $('#notes-filter-reason').value;
            
            const historyContainer = $('#notes-list');
            historyContainer.innerHTML = '';
            const filteredNotes = Object.entries(AppState.notes).filter(([dateStr, note]) => {
                const dateMatch = !filterDate || dateStr === filterDate;
                const moodMatch = filterMood === 'all' || (note.moods && note.moods.includes(filterMood));
                const reasonMatch = filterReason === 'all' || (note.reasons && note.reasons.includes(filterReason));
                return dateMatch && moodMatch && reasonMatch;
            });

            if (filteredNotes.length > 0) {
                filteredNotes.sort((a,b) => new Date(b[0]) - new Date(a[0])).forEach(([dateStr, note]) => {
                    const moods = (note.moods || []).join(', ');
                    const reasons = (note.reasons || []).join(', ');
                    historyContainer.innerHTML += `<div class="border-l-4 border-emerald-500 pl-4 py-2"><p class="font-bold">${formatDate(new Date(dateStr + 'T12:00:00Z'))}</p><p class="text-sm font-semibold">Sentimientos: ${moods}</p><p class="text-sm font-semibold">Razones: ${reasons}</p><p class="text-gray-600 dark:text-gray-300 whitespace-pre-wrap mt-1">${note.text}</p></div>`;
                });
            } else {
                 historyContainer.innerHTML = `<p class="text-center text-gray-500 py-4">No hay notas que coincidan con los filtros.</p>`;
            }
            
            // Render Chart based on filtered notes
            const moodCounts = {};
            filteredNotes.forEach(([,note]) => (note.moods || []).forEach(mood => {
                moodCounts[mood] = (moodCounts[mood] || 0) + 1;
            }));
            const chartCtx = $('#notes-chart').getContext('2d');
            if(notesChartInstance) notesChartInstance.destroy();
            notesChartInstance = new Chart(chartCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(moodCounts),
                    datasets: [{
                        data: Object.values(moodCounts),
                        backgroundColor: ['#34d399', '#facc15', '#fb923c', '#f87171', '#60a5fa', '#c084fc', '#9ca3af', '#f9a8d4'],
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' } } }
            });
        }
        
        function populateNotesFilters(){
            const moodFilter = $('#notes-filter-mood');
            const reasonFilter = $('#notes-filter-reason');
            const currentMood = moodFilter.value;
            const currentReason = reasonFilter.value;

            const allMoods = new Set(Object.values(AppState.notes).flatMap(n => n.moods || []));
            const allReasons = new Set(Object.values(AppState.notes).flatMap(n => n.reasons || []));
            
            moodFilter.innerHTML = '<option value="all">Todos los sentimientos</option>';
            allMoods.forEach(mood => moodFilter.innerHTML += `<option value="${mood}">${mood}</option>`);

            reasonFilter.innerHTML = '<option value="all">Todas las razones</option>';
            allReasons.forEach(reason => reasonFilter.innerHTML += `<option value="${reason}">${reason}</option>`);

            moodFilter.value = currentMood;
            reasonFilter.value = currentReason;
        }

        function renderJournalView() {
            const dateInput = $('#journal-date');
            dateInput.value = toISODateString(new Date());
            const entry = AppState.journal[dateInput.value];
            $('#journal-text').value = entry || '';
        }

        function renderExamsView() {
            $('#exam-table-date').value = toISODateString(new Date());
            const tableBody = $('#exams-table-body');
            tableBody.innerHTML = '';
            const dateStr = $('#exam-table-date').value;
            const dailyExams = AppState.exams[dateStr] || {};
            Object.entries(AppState.examList).forEach(([frequency, exams]) => {
                (exams || []).forEach(exam => {
                    const params = exam.parametros || [exam];
                    params.forEach((param, index) => {
                         const rangeText = param.rango ? `${param.rango.min} - ${param.rango.max} ${param.unidad || ''}`: 'N/A';
                         const value = dailyExams[param.id] || '';
                         tableBody.innerHTML += `<tr class="border-b dark:border-gray-700"><td class="p-2 ${index === 0 ? 'font-bold' : ''}">${index === 0 ? exam.nombre : ''} <span class="text-gray-500 text-xs">${param.nombre !== exam.nombre ? param.nombre : ''}</span></td><td class="p-2 hidden sm:table-cell capitalize">${index === 0 ? frequency : ''}</td><td class="p-2 text-xs">${rangeText}</td><td class="p-2"><input type="number" step="any" data-param-id="${param.id}" value="${value}" class="w-full p-1 border rounded bg-transparent dark:border-gray-600"></td></tr>`;
                    });
                });
            });
        }

        function renderCompareView() {
            const container = $('#compare-table-container');
            container.innerHTML = '';
            const allExams = [].concat(...Object.values(AppState.examList));
            const paramMap = new Map();
            allExams.forEach(exam => (exam.parametros || [exam]).forEach(p => paramMap.set(p.id, p)));
            const dates = Object.keys(AppState.exams).sort((a,b) => new Date(a) - new Date(b));
            if (dates.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No hay datos de exámenes para comparar.</p>'; return;
            }
            let table = '<table class="w-full text-sm text-left"><thead><tr class="border-b dark:border-gray-700"><th class="p-2">Examen</th><th class="p-2">Rango</th>';
            dates.forEach(date => table += `<th class="p-2">${formatDate(new Date(date + 'T12:00:00Z'), {day:'2-digit', month:'short'})}</th>`);
            table += '</tr></thead><tbody>';
            paramMap.forEach(param => {
                table += `<tr class="border-b dark:border-gray-700"><td class="p-2 font-medium">${param.nombre}</td>`;
                const rangeText = param.rango ? `${param.rango.min}-${param.rango.max}` : 'N/A';
                table += `<td class="p-2 text-xs">${rangeText}</td>`;
                dates.forEach(date => {
                    const value = AppState.exams[date][param.id];
                    let cellClass = 'p-2';
                    if (value !== undefined && param.rango && (value < param.rango.min || value > param.rango.max)) {
                        cellClass += ' bg-yellow-200 dark:bg-yellow-800 font-bold';
                    }
                    table += `<td class="${cellClass}">${value ?? '-'}</td>`;
                });
                table += '</tr>';
            });
            container.innerHTML = table + '</tbody></table>';
        }
        
        function renderReportView() {
            const date = AppState.reportDate;
            $('#report-month-year').textContent = formatDate(date, { month: 'long', year: 'numeric' });
            const grid = $('#report-calendar-grid');
            grid.innerHTML = '';
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDayOfMonth; i++) grid.appendChild(document.createElement('div'));
            
            const monthNotes = Object.entries(AppState.notes).filter(([d,]) => d.startsWith(toISODateString(date).slice(0, 7)));
            
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('button');
                const currentDate = new Date(year, month, i);
                const dateStr = toISODateString(currentDate);
                dayEl.textContent = i;
                dayEl.dataset.date = dateStr;
                
                let dayClasses = 'p-2 rounded-full aspect-square flex items-center justify-center transition-colors hover:bg-gray-200 dark:hover:bg-gray-700 ';
                const note = AppState.notes[dateStr];
                if (note && note.moods && note.moods.length > 0) {
                    const positiveMoods = AppState.settings.moodOptions['Positivos'] || [];
                    const negativeMoods = AppState.settings.moodOptions['Negativos'] || [];
                    let score = 0;
                    note.moods.forEach(mood => {
                        if (positiveMoods.includes(mood)) score++;
                        if (negativeMoods.includes(mood)) score--;
                    });

                    if (score > 1) dayClasses += 'day-joy';
                    else if (score === 1) dayClasses += 'day-happy';
                    else if (score === 0) dayClasses += 'day-neutral';
                    else if (score === -1) dayClasses += 'day-sad';
                    else dayClasses += 'day-bad';
                }

                dayEl.className = dayClasses;
                grid.appendChild(dayEl);
            }
        }

        function renderManageView() {
            const container = $('#phases-container');
            container.innerHTML = '';
            if (!AppState.data.fases) AppState.data.fases = [];
            AppState.data.fases.sort((a,b) => new Date(a.inicio) - new Date(b.inicio)).forEach(phase => {
                const phaseEl = document.createElement('div');
                phaseEl.className = 'border dark:border-gray-700 rounded-lg p-4';
                
                let supplementsHtml = (phase.suplementos || []).map((sup, index) => `
                    <div class="flex justify-between items-center py-2 border-b dark:border-gray-600 last:border-b-0">
                        <div>
                            <p class="font-medium">${sup.nombre}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${sup.dosis} - ${sup.horario}</p>
                        </div>
                        <div>
                            <button class="edit-supplement-btn p-1 hover:text-blue-500" data-phase-id="${phase.id}" data-supplement-index="${index}"><span class="material-icons-outlined">edit</span></button>
                            <button class="delete-supplement-btn p-1 hover:text-red-500" data-phase-id="${phase.id}" data-supplement-index="${index}"><span class="material-icons-outlined">delete</span></button>
                        </div>
                    </div>
                `).join('');

                phaseEl.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <div>
                            <h3 class="text-lg font-bold">${phase.nombre}</h3>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${formatDate(new Date(phase.inicio + 'T12:00:00Z'))} - ${formatDate(new Date(phase.fin + 'T12:00:00Z'))}</p>
                        </div>
                        <div>
                           <button class="edit-phase-btn p-1 hover:text-blue-500" data-phase-id="${phase.id}"><span class="material-icons-outlined">edit</span></button>
                           <button class="delete-phase-btn p-1 hover:text-red-500" data-phase-id="${phase.id}"><span class="material-icons-outlined">delete</span></button>
                        </div>
                    </div>
                    <div class="space-y-2">${supplementsHtml}</div>
                    <button class="add-supplement-btn w-full mt-4 text-sm bg-emerald-100 dark:bg-emerald-900 text-emerald-700 dark:text-emerald-200 py-2 rounded-md hover:bg-emerald-200 dark:hover:bg-emerald-800" data-phase-id="${phase.id}">Agregar Suplemento</button>
                `;
                container.appendChild(phaseEl);
            });
             const notifToggle = $('#notifications-toggle');
             const notifTimeContainer = $('#notification-time-container');
             const notifTimeInput = $('#notification-time');
             notifToggle.checked = AppState.settings.notifications.enabled;
             notifTimeInput.value = AppState.settings.notifications.time;
             if (AppState.settings.notifications.enabled) {
                 notifTimeContainer.classList.remove('hidden');
             } else {
                 notifTimeContainer.classList.add('hidden');
             }
             
             // Render mood and reason manager
             renderMoodReasonManager();
        }
        
        function renderMoodReasonManager() {
            const { moodOptions, reasonOptions } = AppState.settings;
            const moodsContainer = $('#moods-list-manage');
            const reasonsContainer = $('#reasons-list-manage');

            moodsContainer.innerHTML = '';
            Object.entries(moodOptions).forEach(([group, moods]) => {
                moodsContainer.innerHTML += `<h5 class="font-semibold mt-2 text-sm">${group}</h5>`;
                moods.forEach(mood => {
                    moodsContainer.innerHTML += `<div class="flex justify-between items-center text-sm p-1"><span class="ml-2">${mood}</span><button data-mood="${mood}" data-group="${group}" class="delete-mood-btn p-1 text-red-500"><span class="material-icons-outlined text-base">delete</span></button></div>`;
                });
            });

            reasonsContainer.innerHTML = '';
            reasonOptions.forEach(reason => {
                reasonsContainer.innerHTML += `<div class="flex justify-between items-center text-sm p-1"><span>${reason}</span><button data-reason="${reason}" class="delete-reason-btn p-1 text-red-500"><span class="material-icons-outlined text-base">delete</span></button></div>`;
            });
        }


        // --- MANEJADORES DE EVENTOS ---
        function setupEventListeners() {
            $('#enter-app-btn').addEventListener('click', () => {
                $('#splash-view').classList.add('fade-out');
                setTimeout(() => { 
                    $('#splash-view').classList.add('hidden');
                    $('#main-container').classList.remove('hidden');
                    $('#main-container').classList.add('fade-in');
                    // After animation, remove the fade-out class from splash view for next time
                    setTimeout(() => $('#splash-view').classList.remove('fade-out'), 500);
                }, 500);
                sessionStorage.setItem('welcomeShown', 'true');
            });
            
            $('#home-btn').addEventListener('click', () => {
                $('#main-container').classList.add('fade-out');
                setTimeout(() => {
                    $('#main-container').classList.add('hidden');
                    $('#main-container').classList.remove('fade-out');
                    const message = AppState.welcomeMessages[Math.floor(Math.random() * AppState.welcomeMessages.length)] || "Cuida tu cuerpo, es el único lugar que tienes para vivir.";
                    $('#welcome-message').textContent = message;
                    $('#splash-view').classList.remove('hidden', 'fade-out');
                    $('#splash-view').classList.add('fade-in');
                }, 500);
            });

            document.querySelectorAll('.nav-button').forEach(b => b.addEventListener('click', () => navigateTo(b.dataset.view)));
            $('#theme-toggle').addEventListener('click', toggleTheme);
            $('#dashboard-day-picker').addEventListener('change', (e) => { 
                if(e.target.value) {
                    AppState.currentDate = new Date(e.target.value + 'T12:00:00Z'); 
                    render();
                }
            });
            $('#symptoms-day-picker').addEventListener('change', (e) => {
                 if(e.target.value) {
                    AppState.currentDate = new Date(e.target.value + 'T12:00:00Z');
                    render();
                 }
            });
            $('#symptoms-uncheck-all').addEventListener('click', () => {
                document.querySelectorAll('#symptoms-checklist input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
            });
            
            // Formularios
            $('#weight-form').addEventListener('submit', handleWeightFormSubmit);
            $('#note-form').addEventListener('submit', handleNoteFormSubmit);
            $('#journal-form').addEventListener('submit', handleJournalFormSubmit);
            $('#password-form').addEventListener('submit', handlePasswordSubmit);
            $('#cancel-password-btn').addEventListener('click', () => $('#password-modal').classList.add('hidden'));
            $('#supplement-form').addEventListener('submit', handleSupplementFormSubmit);
            $('#phase-form').addEventListener('submit', handlePhaseFormSubmit);
            $('#add-mood-form').addEventListener('submit', handleAddMood);
            $('#add-reason-form').addEventListener('submit', handleAddReason);

            // Botones
            $('#save-exams-btn').addEventListener('click', handleSaveExams);
            $('#export-exams-json').addEventListener('click', exportExamsToJSON);
            $('#report-prev-month').addEventListener('click', () => { AppState.reportDate.setMonth(AppState.reportDate.getMonth() - 1); renderReportView(); });
            $('#report-next-month').addEventListener('click', () => { AppState.reportDate.setMonth(AppState.reportDate.getMonth() + 1); renderReportView(); });
            $('#close-report-day-modal').addEventListener('click', () => $('#report-day-modal').classList.add('hidden'));
            $('#reset-app-btn').addEventListener('click', () => promptForPassword('reset'));
            $('#cancel-reset-btn').addEventListener('click', () => $('#reset-confirm-modal').classList.add('hidden'));
            $('#confirm-reset-btn').addEventListener('click', handleResetApp);
            $('#add-phase-btn').addEventListener('click', handleAddPhaseClick);
             $('#cancel-modal').addEventListener('click', () => $('#supplement-modal').classList.add('hidden'));
             $('#cancel-phase-modal').addEventListener('click', () => $('#phase-modal').classList.add('hidden'));
            $('#change-password-btn').addEventListener('click', () => promptForPassword('change'));
            $('#consolidate-journal-btn').addEventListener('click', showJournalReport);
            $('#show-journal-report-btn').addEventListener('click', showJournalReport);
            $('#close-journal-report-modal').addEventListener('click', () => $('#journal-report-modal').classList.add('hidden'));
            $('#save-dashboard-btn').addEventListener('click', handleSaveDashboard);
            $('#save-symptoms-btn').addEventListener('click', handleSaveSymptoms);

            // Notificaciones y carga de archivos
            $('#notifications-toggle').addEventListener('change', handleNotificationsToggle);
            $('#notification-time').addEventListener('change', handleNotificationTimeChange);
            $('#json-upload').addEventListener('change', handleJsonUpload);
            
            // Eventos delegados
            $('#report-calendar-grid').addEventListener('click', (e) => { if(e.target.dataset.date) showReportDayModal(e.target.dataset.date); });
            $('#manage-view').addEventListener('click', handleManageViewClicks);
            
            // Filtros de Notas y Diario
            $('#notes-filter-date').addEventListener('change', renderNotesView);
            $('#notes-filter-mood').addEventListener('change', renderNotesView);
            $('#notes-filter-reason').addEventListener('change', renderNotesView);
            $('#notes-clear-filters').addEventListener('click', () => {
                $('#notes-filter-date').value = '';
                $('#notes-filter-mood').value = 'all';
                $('#notes-filter-reason').value = 'all';
                renderNotesView();
            });
            $('#journal-date').addEventListener('change', (e) => {
                const dateStr = e.target.value;
                const entry = AppState.journal[dateStr] || '';
                $('#journal-text').value = entry;
            });
        }
        
        // --- MANEJADORES DE EVENTOS ESPECÍFICOS ---

        function handleSaveDashboard() {
            const dateStr = $('#dashboard-day-picker').value;
            if (!dateStr) return;
            if (!AppState.history[dateStr]) AppState.history[dateStr] = {};
            document.querySelectorAll('#today-supplements input[type="checkbox"]').forEach(checkbox => {
                const supplementName = checkbox.dataset.name;
                AppState.history[dateStr][supplementName] = checkbox.checked;
            });
            saveState();
            showToast(`Suplementos guardados para ${formatDate(new Date(dateStr + 'T12:00:00Z'))}`);
            renderWeeklyProgress();
        }

        function handleSaveSymptoms() {
            const dateStr = $('#symptoms-day-picker').value;
            if (!dateStr) return;
            if (!AppState.symptoms[dateStr]) AppState.symptoms[dateStr] = {};
            document.querySelectorAll('#symptoms-checklist input[type="checkbox"]').forEach(checkbox => {
                const symptomName = checkbox.dataset.symptom;
                AppState.symptoms[dateStr][symptomName] = checkbox.checked;
            });
            saveState();
            showToast(`Síntomas guardados para ${formatDate(new Date(dateStr + 'T12:00:00Z'))}`);
        }

        function handleWeightFormSubmit(e) {
            e.preventDefault();
            const date = $('#weight-date').value;
            const kg = parseFloat($('#weight-kg').value);
            if (!date || isNaN(kg)) return;
            const sortedDates = Object.keys(AppState.weight).sort();
            const lastDate = sortedDates[sortedDates.length - 1];
            const lastWeight = lastDate ? AppState.weight[lastDate] : null;
            let messageType;
            if (lastWeight) {
                if (kg > lastWeight) messageType = 'gain';
                else if (kg < lastWeight) messageType = 'loss';
            }
            AppState.weight[date] = kg;
            saveState();
            renderWeightView();
            e.target.reset();
            if (messageType && AppState.weightMessages[messageType]) {
                const messages = AppState.weightMessages[messageType];
                const message = messages[Math.floor(Math.random() * messages.length)];
                showToast(message);
            }
        }

        function handleNoteFormSubmit(e) { 
            e.preventDefault();
            const date = $('#note-date').value;
            const selectedMoods = Array.from(document.querySelectorAll('#note-mood-checkboxes input:checked')).map(cb => cb.value);
            const selectedReasons = Array.from(document.querySelectorAll('#note-reason-checkboxes input:checked')).map(cb => cb.value);
            const text = $('#note-text').value;

            if (selectedMoods.length === 0 && selectedReasons.length === 0 && !text.trim()) {
                return showToast("No hay nada que guardar.", true);
            }

            AppState.notes[date] = {
                moods: selectedMoods,
                reasons: selectedReasons,
                text: text
            };
            saveState();
            renderNotesView();
            $('#note-form').reset();
            showToast("Nota guardada con éxito.");
        }
        
        function handleJournalFormSubmit(e) {
            e.preventDefault();
            const date = $('#journal-date').value;
            const text = $('#journal-text').value;
            if (text.trim()) {
                AppState.journal[date] = text;
            } else {
                delete AppState.journal[date];
            }
            saveState();
            showToast("Entrada del diario guardada.");
        }

        function handleSaveExams() {
            const date = $('#exam-table-date').value;
            if (!date) { alert("Por favor, selecciona una fecha."); return; }
            if (!AppState.exams[date]) AppState.exams[date] = {};
            document.querySelectorAll('#exams-table-body input').forEach(input => {
                const value = parseFloat(input.value);
                if (!isNaN(value)) {
                    AppState.exams[date][input.dataset.paramId] = value;
                } else {
                    delete AppState.exams[date][input.dataset.paramId];
                }
            });
            saveState();
            showToast("Resultados de exámenes guardados.");
        }

        function exportExamsToJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(AppState.exams, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "examenes_export.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            showToast("Datos exportados a JSON.");
        }

        function showReportDayModal(dateStr) {
            const date = new Date(dateStr + 'T12:00:00Z');
            $('#report-day-title').textContent = formatDate(date);
            const contentEl = $('#report-day-content');
            contentEl.innerHTML = '';
            // Suplementos
            const supplements = getSupplementsForDate(date);
            const supplementHistory = AppState.history[dateStr] || {};
            let supplementsHtml = '<div><h4 class="font-bold">💊 Suplementos</h4>';
            if (supplements.length > 0) {
                supplementsHtml += '<ul class="list-disc pl-5">';
                supplements.forEach(sup => {
                    const taken = supplementHistory[sup.nombre];
                    supplementsHtml += `<li>${sup.nombre} - <span class="${taken ? 'text-emerald-500' : 'text-red-500'}">${taken ? 'Tomado' : 'No tomado'}</span></li>`;
                });
                supplementsHtml += '</ul>';
            } else {
                supplementsHtml += '<p class="text-gray-500">Sin suplementos.</p>';
            }
            contentEl.innerHTML += supplementsHtml + '</div>';
            // Síntomas
            const symptoms = AppState.symptoms[dateStr] || {};
            let symptomsHtml = '<div><h4 class="font-bold">❤️ Síntomas</h4>';
            if (Object.keys(symptoms).length > 0) {
                symptomsHtml += '<ul class="list-disc pl-5">';
                Object.entries(symptoms).forEach(([name, checked]) => {
                    if (checked) symptomsHtml += `<li>${name}</li>`;
                });
                symptomsHtml += '</ul>';
            } else {
                symptomsHtml += '<p class="text-gray-500">Sin registro de síntomas.</p>';
            }
            contentEl.innerHTML += symptomsHtml + '</div>';
            // Peso
            const weight = AppState.weight[dateStr];
            contentEl.innerHTML += `<div><h4 class="font-bold">⚖️ Peso</h4><p>${weight ? weight + ' kg' : 'Sin registro de peso.'}</p></div>`;
            $('#report-day-modal').classList.remove('hidden');
        }

        function showJournalReport() {
            const contentEl = $('#journal-report-content');
            contentEl.innerHTML = '';
            const allNoteDates = Object.keys(AppState.notes);
            const allJournalDates = Object.keys(AppState.journal);
            const allDates = [...new Set([...allNoteDates, ...allJournalDates])];
            
            const sortedDates = allDates.sort((a,b) => new Date(a) - new Date(b));

            sortedDates.forEach(dateStr => {
                 const note = AppState.notes[dateStr];
                 const journal = AppState.journal[dateStr];
                 contentEl.innerHTML += `<div class="mb-4"><h3 class="font-bold text-lg">${formatDate(new Date(dateStr + 'T12:00:00Z'))}</h3></div>`;
                 if (note) {
                    const moods = (note.moods || []).join(', ');
                    contentEl.innerHTML += `<div class="pl-4 mb-2"><p class="font-semibold">Nota Rápida:</p><p class="text-sm">Sentimientos: ${moods}</p><p class="whitespace-pre-wrap">${note.text}</p></div>`;
                 }
                 if (journal) {
                    contentEl.innerHTML += `<div class="pl-4"><p class="font-semibold">Entrada de Diario:</p><p class="whitespace-pre-wrap">${journal}</p></div>`;
                 }
            });

            $('#journal-report-modal').classList.remove('hidden');
        }
        
        // --- LÓGICA DE CONTRASEÑA ---
        function promptForPassword(mode) {
             AppState.passwordMode = mode;
             const modal = $('#password-modal');
             const title = $('#password-modal-title');
             const text = $('#password-modal-text');
             const oldInput = $('#password-old-input');
             const confirmInput = $('#password-confirm-input');
             
             oldInput.classList.add('hidden');
             confirmInput.classList.add('hidden');
             
             if (!AppState.settings.notesPassword && mode !== 'create') {
                return promptForPassword('create');
             }

             if (mode === 'create') {
                title.textContent = 'Crear Contraseña';
                text.textContent = 'Crea una contraseña para proteger tus notas. Guárdala en un lugar seguro.';
                confirmInput.classList.remove('hidden');
             } else if (mode === 'change') {
                title.textContent = 'Cambiar Contraseña';
                text.textContent = 'Ingresa tu contraseña actual y la nueva.';
                oldInput.classList.remove('hidden');
                confirmInput.classList.remove('hidden');
             } else if (mode === 'reset') {
                 title.textContent = 'Confirmar para Resetear';
                 text.textContent = 'Ingresa tu contraseña para confirmar que deseas resetear la aplicación.';
             } else { // login
                title.textContent = 'Ingresar Contraseña';
                text.textContent = 'Ingresa tu contraseña para ver tus notas.';
             }
             
             modal.classList.remove('hidden');
             $('#password-input').focus();
        }

        function handlePasswordSubmit(e) {
            e.preventDefault();
            const oldPassword = $('#password-old-input').value;
            const password = $('#password-input').value;
            const confirmPassword = $('#password-confirm-input').value;
            const mode = AppState.passwordMode;

            if (mode === 'create') {
                if (password !== confirmPassword) { return alert("Las contraseñas no coinciden."); }
                AppState.settings.notesPassword = password;
                AppState.notesUnlocked = true;
                showToast("Contraseña creada con éxito.");
                navigateTo(AppState.viewToUnlock || 'notes');
            } else if (mode === 'change') {
                if (oldPassword !== AppState.settings.notesPassword) { return alert("La contraseña actual es incorrecta."); }
                if (password !== confirmPassword) { return alert("Las nuevas contraseñas no coinciden."); }
                AppState.settings.notesPassword = password;
                showToast("Contraseña cambiada con éxito.");
            } else if (mode === 'reset') {
                if (password === AppState.settings.notesPassword) {
                    $('#password-modal').classList.add('hidden');
                    $('#reset-confirm-modal').classList.remove('hidden');
                } else {
                    return alert("Contraseña incorrecta.");
                }
            } else { // login
                if (password === AppState.settings.notesPassword) {
                    AppState.notesUnlocked = true;
                    navigateTo(AppState.viewToUnlock || 'notes');
                } else {
                    return alert("Contraseña incorrecta.");
                }
            }
            
            saveState();
            if (mode !== 'reset') {
                $('#password-modal').classList.add('hidden');
            }
            $('#password-form').reset();
        }

        // --- TOAST NOTIFICATION ---
        function showToast(message, isError = false) {
            const toast = $('#toast-notification');
            $('#toast-message').textContent = message;
            toast.classList.toggle('bg-red-500', isError);
            toast.classList.toggle('text-white', isError);
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 4000);
        }
        
        // --- LÓGICA DE GESTIÓN, TEMAS Y OTRAS UTILIDADES ---
        function getCurrentPhase(date) {
            if (!AppState.data.fases) return null;
            const dateStr = toISODateString(date);
            return AppState.data.fases.find(fase => dateStr >= fase.inicio && dateStr <= fase.fin);
        }

        function getSupplementsForDate(date) {
            const phase = getCurrentPhase(date);
            return phase ? phase.suplementos || [] : [];
        }

        function applyTheme() {
            if (AppState.settings.theme === 'dark') {
                document.documentElement.classList.add('dark');
                $('#theme-icon').textContent = 'dark_mode';
            } else {
                document.documentElement.classList.remove('dark');
                $('#theme-icon').textContent = 'light_mode';
            }
        }

        function toggleTheme() {
            AppState.settings.theme = AppState.settings.theme === 'light' ? 'dark' : 'light';
            saveState();
            applyTheme();
        }

        let notificationTimeout = null;
        async function handleNotificationsToggle(event) {
            const enabled = event.target.checked;
            if (enabled) {
                if (!('Notification' in window)) {
                    alert('Este navegador no soporta notificaciones.');
                    event.target.checked = false;
                    return;
                }
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    AppState.settings.notifications.enabled = true;
                    scheduleNextNotification();
                    $('#notification-time-container').classList.remove('hidden');
                } else {
                    alert('Permiso de notificaciones denegado.');
                    event.target.checked = false;
                    AppState.settings.notifications.enabled = false;
                }
            } else {
                AppState.settings.notifications.enabled = false;
                clearTimeout(notificationTimeout);
                $('#notification-time-container').classList.add('hidden');
            }
            saveState();
        }
        function handleNotificationTimeChange(event) {
            AppState.settings.notifications.time = event.target.value;
            saveState();
            scheduleNextNotification();
        }
        function scheduleNextNotification() {
            if (!AppState.settings.notifications.enabled || Notification.permission !== 'granted') return;
            clearTimeout(notificationTimeout);
            const [hours, minutes] = AppState.settings.notifications.time.split(':').map(Number);
            const now = new Date();
            let notificationTime = new Date();
            notificationTime.setHours(hours, minutes, 0, 0);
            if (now > notificationTime) {
                notificationTime.setDate(notificationTime.getDate() + 1);
            }
            const timeToNotification = notificationTime.getTime() - now.getTime();
            notificationTimeout = setTimeout(() => {
                showDailyNotification();
                scheduleNextNotification();
            }, timeToNotification);
        }
        function showDailyNotification() {
             const supplementsToday = getSupplementsForDate(new Date());
             const remaining = supplementsToday.filter(sup => !(AppState.history[toISODateString(new Date())] && AppState.history[toISODateString(new Date())][sup.nombre]));
             const body = remaining.length > 0 ? `Tienes ${remaining.length} suplemento(s) pendiente(s).` : '¡Ya completaste tus suplementos de hoy! 🎉';
             new Notification('Recordatorio de Suplementos', { body, icon: 'https://placehold.co/192x192/34d399/ffffff?text=Salud' });
        }

        function handleManageViewClicks(e) {
             const button = e.target.closest('button');
             if (!button) return;
             const phaseId = parseInt(button.dataset.phaseId);
             const supplementIndex = button.dataset.supplementIndex ? parseInt(button.dataset.supplementIndex) : -1;

             if (button.classList.contains('delete-mood-btn')) {
                const { mood, group } = button.dataset;
                AppState.settings.moodOptions[group] = AppState.settings.moodOptions[group].filter(m => m !== mood);
                saveState();
                renderManageView();
             } else if (button.classList.contains('delete-reason-btn')) {
                const { reason } = button.dataset;
                AppState.settings.reasonOptions = AppState.settings.reasonOptions.filter(r => r !== reason);
                saveState();
                renderManageView();
             } else if (button.classList.contains('add-supplement-btn')) openSupplementModal({ phaseId });
             else if (button.classList.contains('edit-supplement-btn')) openSupplementModal({ phaseId, supplementIndex });
             else if (button.classList.contains('delete-supplement-btn')) {
                 AppState.data.fases.find(p => p.id === phaseId).suplementos.splice(supplementIndex, 1);
                 saveState(); render();
             } else if (button.classList.contains('edit-phase-btn')) openPhaseModal(phaseId);
             else if (button.classList.contains('delete-phase-btn')) {
                 AppState.data.fases = AppState.data.fases.filter(p => p.id !== phaseId);
                 saveState(); render();
             }
        }
        
        function handleAddMood(e) {
            e.preventDefault();
            const input = $('#new-mood-input');
            const group = $('#new-mood-group').value;
            const newMood = input.value.trim();
            if (newMood) {
                if (!AppState.settings.moodOptions[group].includes(newMood)) {
                    AppState.settings.moodOptions[group].push(newMood);
                    saveState();
                    renderManageView();
                    input.value = '';
                } else {
                    alert('Este sentimiento ya existe.');
                }
            }
        }
        
        function handleAddReason(e) {
            e.preventDefault();
            const input = $('#new-reason-input');
            const newReason = input.value.trim();
            if (newReason) {
                 if (!AppState.settings.reasonOptions.includes(newReason)) {
                    AppState.settings.reasonOptions.push(newReason);
                    saveState();
                    renderManageView();
                    input.value = '';
                } else {
                    alert('Esta razón ya existe.');
                }
            }
        }

        function openSupplementModal({ phaseId, supplementIndex = -1 }) {
            const form = $('#supplement-form');
            form.reset();
            $('#modal-phase-id').value = phaseId;
            $('#modal-supplement-index').value = supplementIndex;
            if (supplementIndex > -1) {
                const supplement = AppState.data.fases.find(p => p.id === phaseId).suplementos[supplementIndex];
                $('#modal-title').textContent = 'Editar Suplemento';
                $('#supplement-name').value = supplement.nombre;
                $('#supplement-dosis').value = supplement.dosis;
                $('#supplement-horario').value = supplement.horario;
            } else {
                $('#modal-title').textContent = 'Agregar Suplemento';
            }
            $('#supplement-modal').classList.remove('hidden');
        }

        function handleSupplementFormSubmit(e) {
            e.preventDefault();
            const phaseId = parseInt($('#modal-phase-id').value);
            const supplementIndex = parseInt($('#modal-supplement-index').value);
            const phase = AppState.data.fases.find(p => p.id === phaseId);
            const newSupplement = {
                nombre: $('#supplement-name').value,
                dosis: $('#supplement-dosis').value,
                horario: $('#supplement-horario').value
            };
            if (supplementIndex > -1) {
                phase.suplementos[supplementIndex] = newSupplement;
            } else {
                if (!phase.suplementos) phase.suplementos = [];
                phase.suplementos.push(newSupplement);
            }
            saveState(); render();
            $('#supplement-modal').classList.add('hidden');
        }

        function openPhaseModal(phaseId = -1) {
             const form = $('#phase-form');
             form.reset();
             $('#modal-phase-edit-id').value = phaseId;
             if (phaseId > -1) {
                const phase = AppState.data.fases.find(p => p.id === phaseId);
                $('#phase-modal-title').textContent = 'Editar Fase';
                $('#phase-name').value = phase.nombre;
                $('#phase-start').value = phase.inicio;
                $('#phase-end').value = phase.fin;
             } else {
                $('#phase-modal-title').textContent = 'Agregar Nueva Fase';
             }
             $('#phase-modal').classList.remove('hidden');
        }

        function handleAddPhaseClick() { openPhaseModal(); }
        
        function handlePhaseFormSubmit(e) {
            e.preventDefault();
            const phaseId = parseInt($('#modal-phase-edit-id').value);
            const newPhaseData = {
                nombre: $('#phase-name').value,
                inicio: $('#phase-start').value,
                fin: $('#phase-end').value
            };
            if (phaseId > -1) {
                const phaseIndex = AppState.data.fases.findIndex(p => p.id === phaseId);
                AppState.data.fases[phaseIndex] = { ...AppState.data.fases[phaseIndex], ...newPhaseData };
            } else {
                const newId = AppState.data.fases.length > 0 ? Math.max(...AppState.data.fases.map(p => p.id)) + 1 : 0;
                AppState.data.fases.push({ id: newId, ...newPhaseData, suplementos: [] });
            }
            saveState(); render();
            $('#phase-modal').classList.add('hidden');
        }

        function handleJsonUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = JSON.parse(e.target.result);
                    if (content.fases && Array.isArray(content.fases)) {
                        AppState.data = content;
                        saveState(); render();
                        showToast("Datos importados con éxito.");
                    } else { throw new Error("Formato de JSON no válido."); }
                } catch (error) {
                    console.error('Error al leer el archivo JSON.', error);
                    alert("Error al procesar el archivo. Asegúrate de que tiene el formato correcto.");
                }
            };
            reader.readAsText(file);
        }

        function handleResetApp() {
            localStorage.removeItem('healthApp');
            sessionStorage.removeItem('welcomeShown');
            location.reload();
        }

        init();
    </script>
</body>
</html>

